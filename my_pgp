#!/usr/bin/env python3

from Parser import *

from Aes.AES import Aes
from Xor.Xor import Xor
from RSA.RSA import Rsa
from PGP_XOR.PGP_XOR import PgpXor
from PGP_AES.PGP_AES import PgpAes

def GetHelpCaption():
    return """USAGE
    ./my_pgp CRYPTO_SYSTEM MODE [OPTIONS] [key]

DESCRIPTION

The MESSAGE is read from standard input
  CRYPTO_SYSTEM
    "xor"       computation using XOR algorithm
    "aes"       computation using 128-bit AES algorithm
    "rsa"       computation using RSA algorithm
    "pgp-xor"   computation using both RSA and XOR algorithm
    "pgp-aes"   computation using both RSA and 128-bit AES algorithm

  MODE
    -c          MESSAGE is clear and we want to cipher it
    -d          MESSAGE is ciphered and we want to decipher it
    -g P Q      for RSA only: Don't read a MESSAGE, but instead generate a public and private key pair from the prime number P and Q

  OPTIONS
    -b          for XOR, AES and PGP, only works on one block. The MESSAGE and the symmetric key must be the same size

  key Key used to cipher/decipher MESSAGE (incompatible with -g MODE)"""

crypto_systems = {
    "xor": Xor,
    "aes": Aes,
    "rsa": Rsa,
    "pgp-xor": PgpXor,
    "pgp-aes": PgpAes
}

def main():
    if len(sys.argv) == 2 and sys.argv[1] == "-h":
        print(GetHelpCaption())
        return 0

    parser = Parser(sys.argv)
    if parser.mode == Mode.GENERATE:
        rsa = Rsa(bytes(0))
        rsa.setGenValue(parser.pValue, parser.qValue)
        rsa.generateKeys()
        rsa.displayKeys()
        return
    if parser.system == parser.AlgorithmName[Algorithm.RSA.value]:
        rsa = Rsa(bytes(0))
        rsa.setLeftRightValue(parser.leftValue, parser.rightValue)
        if parser.mode == Mode.ENCRYPT:
            print(rsa._encrypt(parser.message))
        else:
            print(rsa._decrypt(parser.message))
        return
    if parser.system == parser.AlgorithmName[Algorithm.PGP_AES.value] or parser.system == parser.AlgorithmName[Algorithm.PGP_XOR.value]:
        pgp = None
        if parser.system == parser.AlgorithmName[Algorithm.PGP_AES.value]:
            pgp = PgpAes(parser.key)
        else:
            pgp = PgpXor(parser.key)
        pgp.setLeftRightValue(parser.leftValue, parser.rightValue)
        pgp.setIsBlockMode(parser.hasOption)
        if parser.mode == Mode.ENCRYPT:
            print(pgp._encrypt(parser.message))
        else:
            print(pgp._decrypt(parser.message))
        return

    system = crypto_systems[parser.system](parser.key).getMode(parser.mode)(parser.message)
    print(system)

if __name__ == "__main__":
    main()
